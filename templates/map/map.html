{% extends "base.html" %}
{% load static %}
{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/reset.css">
<link rel="stylesheet" href="{% static 'css/style-pth.css' %}">
{% endblock %}
{% block content %}
        <div class="option">
            <form onsubmit="searchPlaces(); return false;">
                    <input type="text" value=" " id="keyword" size="15"> 
                    <button type="submit" class="search-button">ê²€ìƒ‰</button> 
            </form>
        </div>
        <div class="map_wrap">
            <div id="map"></div>
            <div id="menu_wrap" class="bg_white">
                <hr>
                <ul id="placesList"></ul>
                <div id="pagination"></div>
            </div>
            <div class="bottom-btn"> 
                <button id="list-btn" class="list-button" onclick="toggleParkingList()">ì£¼ì°¨ì¥ ë¦¬ìŠ¤íŠ¸</button>
            </div>
            <div id="parkingListWrap" style="display: none;">
                <div class="sort-btn">
                    <div>
                        <i id="delete-btn" class="ri-close-large-line"></i>
                        <label for="hours">ì£¼ì°¨í•  ì‹œê°„:</label>
                        <input type="number" id="hours"  min="0"> ì‹œê°„
                        <input type="number" id="minutes" min="0" max="59"> ë¶„
                        <button class="adjust" onclick="calculateAndSortParkingFees()">ì ìš©</button>
                    </div>
                    <div class="list-way">
                        <button onclick="calculateAndSortParkingFees()">ìš”ê¸ˆìˆœ</button>
                        <p> ã…£ </p>
                        <button onclick="showClosestParkingLots()">ê±°ë¦¬ìˆœ</button>
                        <p> ã…£ </p>
                        <button onclick="showRatingParkingLots()">ë³„ì ìˆœ</button>
                    </div>
                </div>
                <ul id="parkingList"></ul>
            </div>
            <div id="parkingDetailWrap" style="display: none;">
                <i id="delete-btn2" class="ri-close-large-line"></i>
                <div class="firstline">
                    <span id="parkingTitle"></span>
                    <i id="toggle-btn" onclick="toggleLike()" class="ri-heart-3-line"></i>
                    <span id="parkingInfo1"></span>
                </div>
                <span id="parkingInfo2"></span>
                <p id="parkingReview">ë¦¬ë·°
                    <i id="toggle-btn" onclick="toggleReview()" class="ri-arrow-down-s-fill"></i>
                </p>
                <div id="review" class="review">
                    <div class="star-rating">
                        <i class="ri-star-line" data-value="1"></i>
                        <i class="ri-star-line" data-value="2"></i>
                        <i class="ri-star-line" data-value="3"></i>
                        <i class="ri-star-line" data-value="4"></i>
                        <i class="ri-star-line" data-value="5"></i>
                    </div>
                    <p id="rating-display">0ì </p>
                    <textarea id="contentInput" placeholder="ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    <button class="review-btn" onclick="addReview()">ë¦¬ë·° ë“±ë¡</button>
                    <div class="review-list">
                    </div>
                </div>
                {% comment %}
                <p id="parkingCommunity">ì»¤ë®¤ë‹ˆí‹°
                    <i id="toggle-btn2" onclick="toggleCommunity()" class="ri-arrow-down-s-fill"></i>
                </p>
                <div id="community" class="community">
                    <div class="messages">
                    </div>
                    <div class="input-msg">
                        <input id="messageInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                        <button class="community-btn" onclick="sendMessage()">ì „ì†¡</button>
                    </div>
                {% endcomment %}
                </div>
            </div>
        </div>
        {% endblock %}

        {% block scripts %}

        {% if parking_data %}
        {{ parking_data | json_script:'jsonData' }}
        {% endif %}
        <script>
            document.getElementById('keyword').value = localStorage.getItem('search_txt') || '';
        </script>
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{MAP_KEY}}&libraries=services"></script>
        <script>
            var markers = [];
            var parkingData = [];
            var selectedPlace = null;
            let debounceTimeout = null;
            let selectedParkingLotId = null;
            let selectedPlaceMarker = null;
            var visibleparkinglot = [];
            var parkingTime = null;
            let selectedRating = 0;
            const currentUser = "{{ user.username }}";

            var mapContainer = document.getElementById('map'), 
                mapOption = {
                    center: new kakao.maps.LatLng(37.566826, 126.9786567), 
                    level: 3 
                };

            var map = new kakao.maps.Map(mapContainer, mapOption); 

            var ps = new kakao.maps.services.Places(); 

            var infowindow = new kakao.maps.InfoWindow({ zIndex: 1 }); 
            var openInfoWindows = [];

            searchPlaces(); 
            loadParkingData();

            function searchPlaces() {
                selectedPlace = null;
                var keyword = document.getElementById('keyword').value;

                if (!keyword.replace(/^\s+|\s+$/g, '')) {
                    alert('ì£¼ì†Œë‚˜ ì¥ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return false;
                }

                ps.keywordSearch(keyword, placesSearchCB); 
            }

            function placesSearchCB(data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
                    if (selectedPlaceMarker) {
                        selectedPlaceMarker.setMap(null);
                        selectedPlaceMarker = null;
                    }
                    var menuEl = document.getElementById('menu_wrap');
                    menuEl.style.display = 'block';
                    closeAllInfoWindows();
                    document.getElementById('parkingListWrap').style.display = "none";
                    document.getElementById('parkingDetailWrap').style.display = "none";
                    document.getElementById('list-btn').style.display = "block";
                    displayPlaces(data); 
                    displayPagination(pagination); 
                } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                } else if (status === kakao.maps.services.Status.ERROR) {
                    alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            function displayPlaces(places) {
                var listEl = document.getElementById('placesList');
                var menuEl = document.getElementById('menu_wrap');
                var fragment = document.createDocumentFragment();
                var bounds = new kakao.maps.LatLngBounds();

                removeAllChildNods(listEl); 
                removeMarker(); 

                for (var i = 0; i < places.length; i++) {
                    var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x);
                    var marker = addMarker(placePosition, i);
                    var itemEl = getListItem(i, places[i]);

                    bounds.extend(placePosition); 

                    (function (marker, title) {
                        kakao.maps.event.addListener(marker, 'mouseover', function () {
                            displayInfowindow(marker, title);
                        });

                        kakao.maps.event.addListener(marker, 'mouseout', function () {
                            infowindow.close();
                        });

                        itemEl.onmouseover = function () {
                            displayInfowindow(marker, title);
                        };

                        itemEl.onmouseout = function () {
                            infowindow.close();
                        };

                        itemEl.onclick = function () {
                            focusOnPlace(marker);
                        };

                        kakao.maps.event.addListener(marker, 'click', function () {
                            focusOnPlace(marker);
                        });
                    })(marker, places[i].place_name);

                    fragment.appendChild(itemEl);
                }

                listEl.appendChild(fragment);
                menuEl.scrollTop = 0;

                map.setBounds(bounds); 
            }

            function getListItem(index, places) {
                var el = document.createElement('li');
                var itemStr =
                    '<span class="markerbg marker_' +
                    (index + 1) +
                    '"></span>' +
                    '<div class="info">' +
                    '<h5>' +
                    places.place_name +
                    '</h5>';

                if (places.road_address_name) {
                    itemStr +=
                        '<span>' +
                        places.road_address_name +
                        '</span>' +
                        '<span class="jibun gray">' +
                        places.address_name +
                        '</span>';
                } else {
                    itemStr += '<span>' + places.address_name + '</span>';
                }

                itemStr += '<span class="tel">' + places.phone + '</span></div>';

                el.innerHTML = itemStr;
                el.className = 'item';

                return el;
            }

            function addMarker(position, idx, title) {
                var imageSrc =
                    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png';
                var imageSize = new kakao.maps.Size(36, 37);
                var imgOptions = {
                    spriteSize: new kakao.maps.Size(36, 691),
                    spriteOrigin: new kakao.maps.Point(0, idx * 46 + 10),
                    offset: new kakao.maps.Point(13, 37),
                };

                var markerImage = new kakao.maps.MarkerImage(
                    imageSrc,
                    imageSize,
                    imgOptions
                );
                var marker = new kakao.maps.Marker({
                    position: position,
                    image: markerImage,
                });

                marker.setMap(map);
                markers.push(marker);

                return marker;
            }
            function addparkMarker(position, idx, title, seat, parking) {
                if (openInfoWindows[idx]) {
                    openInfoWindows[idx].close();
                }
                var marker = new kakao.maps.Marker({
                    position: position, 
                });

                marker.setMap(map);
                markers.push(marker);

                var infowindow = new kakao.maps.InfoWindow({
                    content: `<div style="padding:5px; font-size:12px; width:150px; height:50px; text-align:center; display:flex; align-items:center; justify-content:center;">${title}<br>ë‚¨ì€ìë¦¬: ${seat}</div>` 
                });

                infowindow.open(map, marker);
                openInfoWindows.push(infowindow);
                openInfoWindows[idx] = infowindow;

                kakao.maps.event.addListener(marker, 'click', function () {
                    showParkingDetail(parking);
                });

                return marker;
            }
            function addSelectedMarker(lat, lng) {
                var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markers_sprites2.png';
                markerImageSize = new kakao.maps.Size(36, 37), 
                markerImageOptions = { 
                    spriteSize: new kakao.maps.Size(125, 146), 
                    spriteOrigin: new kakao.maps.Point(0, 0), 
                    offset: new kakao.maps.Point(12, 37) 
                };
                var markerImage = new kakao.maps.MarkerImage(imageSrc, markerImageSize, markerImageOptions);

                var newMarker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(lat, lng), 
                    image: markerImage
                });
                newMarker.setMap(map); 
                return newMarker;
                }
            function closeAllInfoWindows() {
                openInfoWindows.forEach(iw => iw.close());  
                openInfoWindows = []; 
            }
            function removeMarker() {
                markers.forEach(marker => marker.setMap(null));
                markers = []; 
            }

            function displayPagination(pagination) {
                var paginationEl = document.getElementById('pagination');
                var fragment = document.createDocumentFragment();
                var i;

                while (paginationEl.hasChildNodes()) {
                    paginationEl.removeChild(paginationEl.lastChild);
                }

                for (i = 1; i <= pagination.last; i++) {
                    var el = document.createElement('a');
                    el.href = '#';
                    el.innerHTML = i;

                    if (i === pagination.current) {
                        el.className = 'on';
                    } else {
                        el.onclick = (function (i) {
                            return function () {
                                pagination.gotoPage(i);
                            };
                        })(i);
                    }

                    fragment.appendChild(el);
                }
                paginationEl.appendChild(fragment);
            }

            function displayInfowindow(marker, title) {
                var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';
                infowindow.setContent(content);
                infowindow.open(map, marker);
            }

            function focusOnPlace(marker) {
                var menuEl = document.getElementById('menu_wrap');
                menuEl.style.display = 'none';
                removeMarker(marker); 
                map.setLevel(4);
                
                map.setCenter(marker.getPosition());
                infowindow.close();

                selectedPlace = marker.getPosition();

                var lat = marker.getPosition().getLat();
                var lng = marker.getPosition().getLng();
                selectedPlaceMarker = addSelectedMarker(lat, lng);
                updateVisibleParkingMarkers();
            }

            // ì£¼ì°¨ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            function loadParkingData() {
                var placeData = JSON.parse('{{ parking_data|escapejs }}');
                console.log("ì›ë³¸ ë°ì´í„°:", placeData);
                placeData.forEach(function(place) {
                    parkingData.push({
                        'id': place['id'], 
                        'ì£¼ì°¨ì¥ëª…': place['name'],
                        'ìœ„ë„': parseFloat(place['latitude']) || 0,  
                        'ê²½ë„': parseFloat(place['longitude']) || 0, 
                        'ì£¼ì°¨ê¸°ë³¸ì‹œê°„': parseFloat(place['base_time']),
                        'ì£¼ì°¨ê¸°ë³¸ìš”ê¸ˆ': parseFloat(place['base_fee']),
                        'ì¶”ê°€ë‹¨ìœ„ì‹œê°„': parseFloat(place['extra_time']),
                        'ì¶”ê°€ë‹¨ìœ„ìš”ê¸ˆ': parseFloat(place['extra_fee']),
                        'ìš”ê¸ˆì •ë³´': place['fee_info'],
                        'ì£¼ì°¨ì¥ìœ í˜•': place['type'],
                        'ì¥ì• ì¸ì „ìš©ì£¼ì°¨êµ¬ì—­ë³´ìœ ì—¬ë¶€': place['disabled_parking'],
                        'ì†Œì¬ì§€ì§€ë²ˆì£¼ì†Œ': place['lot_address'],
                        'ë‚¨ì€ìë¦¬': parseInt(place['available_spots']),
                        'ë³„ì í‰ê· ': parseFloat(place['average_rating'])
                    });
                }); 

                //updateParkingDisplay();
            }

            // ì‹¤ì‹œê°„ ë°ì´í„° ê°±ì‹ 
            function fetchRealTimeData() {
                fetch('/api/real-time-parking/')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(function(realTimeInfo) {
                            const parking = parkingData.find(p => p['ì†Œì¬ì§€ì§€ë²ˆì£¼ì†Œ'] === realTimeInfo['lot_address']);
                            if (parking) {
                                parking['ë‚¨ì€ìë¦¬'] = parseInt(realTimeInfo['available_spots']);
                                if (parking['ë‚¨ì€ìë¦¬'] > 0) {
                                    console.log(`ì£¼ì†Œ: ${parking['ì†Œì¬ì§€ì§€ë²ˆì£¼ì†Œ']}, ì£¼ì°¨ì¥: ${parking['ì£¼ì°¨ì¥ëª…']}, ë‚¨ì€ìë¦¬: ${parking['ë‚¨ì€ìë¦¬']}`);
                                }
                            }
                            
                        });
                        //updateParkingDisplay();
                    })
                    .catch(error => console.error('ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error));
            }

            // ì£¼ì°¨ì¥ ë°ì´í„° í‘œì‹œ (ì˜ˆì‹œ)
            function updateParkingDisplay() {
                parkingData.forEach(function(place) {
                    console.log(`ì£¼ì°¨ì¥: ${place['ì£¼ì°¨ì¥ëª…']} | ë‚¨ì€ ìë¦¬: ${place['ë‚¨ì€ìë¦¬']}ê°œ`);
                    // ì§€ë„ ë§ˆì»¤ ë˜ëŠ” DOM ìš”ì†Œ ì—…ë°ì´íŠ¸
                });
            }

            // ì´ˆê¸° ë¡œë”©
            fetchRealTimeData();

            // 1ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹ 
            setInterval(fetchRealTimeData, 50000);  // 1ë¶„ ê°„ê²©

            // ì§€ë„ ì´ë™ ì‹œ ë³´ì´ëŠ” ì£¼ì°¨ì¥ ë§ˆì»¤ë§Œ í‘œì‹œí•˜ëŠ” ê¸°ëŠ¥ ì¶”ê°€
            kakao.maps.event.addListener(map, 'bounds_changed', function () {
                if (!selectedPlace) return;
                clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => {
                        updateVisibleParkingMarkers();
                    }, 300);
                });

            function updateVisibleParkingMarkers() {
                
                var bounds = map.getBounds(); 

                removeMarker(); 

                var visibleParking = parkingData.filter(parking => {
                var parkingLatLng = new kakao.maps.LatLng(parking.ìœ„ë„, parking.ê²½ë„);
                
                //ì§€ë„ í™”ë©´ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
                var isInBounds = bounds.contain(parkingLatLng);

                //ì„ íƒí•œ ì¥ì†Œì—ì„œ 2km ì´ë‚´ì¸ì§€ í™•ì¸
                var distanceFromSelected = getDistance(selectedPlace, parkingLatLng);
                var isWithin2km = distanceFromSelected <= 2; // 2km ì´ë‚´ ì—¬ë¶€
                
                return isInBounds && isWithin2km;
                });

                visibleParking.forEach((parking, index) => {
                    var parkingLatLng = new kakao.maps.LatLng(parking.ìœ„ë„, parking.ê²½ë„);
                    addparkMarker(parkingLatLng, index, parking.ì£¼ì°¨ì¥ëª…, parking.ë‚¨ì€ìë¦¬, parking);
                    
                });
            }

            function removeAllChildNods(el) {
                while (el.hasChildNodes()) {
                    el.removeChild(el.lastChild);
                }
            }
            function showClosestParkingLots() {
                visibleparkinglot = [];  // â­ ì¤‘ë³µ ë°©ì§€: ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
                var parkingListEl = document.getElementById('parkingList');
                var parkingListDelete = document.getElementById("delete-btn");
                var parkingList = document.getElementById("list-btn");
                parkingListEl.innerHTML = ""; 

                var hours = parseInt(document.getElementById('hours').value, 10) || 0;
                var minutes = parseInt(document.getElementById('minutes').value, 10) || 0;
                parkingTime = (hours * 60) + minutes; 

                if (parkingTime <= 0) {
                    parkingTime = null;
                }

                visibleparkinglot = parkingData.map(parking => {
                    var parkingLatLng = new kakao.maps.LatLng(parking.ìœ„ë„, parking.ê²½ë„);
                    var distance = getDistance(selectedPlace, parkingLatLng);
                    return { ...parking, distance };
                }).filter((parking, index, self) =>
                    parking.distance <= 2 &&
                    index === self.findIndex(p => p.id === parking.id)  // ì¤‘ë³µ ì œê±°
                );

                if (visibleparkinglot.length === 0) {
                    parkingListEl.innerHTML = "<li>í˜„ì¬ ì§€ë„ì— í‘œì‹œëœ ì£¼ì°¨ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
                    return;
                }

                visibleparkinglot.sort((a, b) => a.distance - b.distance);
                visibleparkinglot.forEach((parking, index) => {
                    console.log(`ğŸ“ ì£¼ì°¨ì¥ ${index + 1}:`, parking);
                    var feeText = ""; 

                    if (parkingTime !== null) {
                        var totalFee = calculateFee(parking, parkingTime);
                        feeText = ` - ìš”ê¸ˆ: ${totalFee}`;
                    }

                    var li = document.createElement('li');
                    li.innerHTML = `<b>${index + 1}. ${parking.ì£¼ì°¨ì¥ëª…}</b> (${parking.distance.toFixed(2)} km)${feeText} (<i class="ri-star-fill"></i> ${parking.ë³„ì í‰ê·  || "í‰ì  ì—†ìŒ"})`;
                    li.onclick = function () {
                        showParkingDetail(parking);
                    };
                    parkingListEl.appendChild(li);
                });

                parkingListDelete.addEventListener("click", function () {
                    parkingListWrap.style.display = "none";
                    parkingList.style.display = "block"; 
        });

                document.getElementById('parkingListWrap').style.display = "block"; 
                document.getElementById('parkingDetailWrap').style.display = "none"; 
            }

            function calculateFee(parking, time) {
                    var basicTime = parseInt(parking.ì£¼ì°¨ê¸°ë³¸ì‹œê°„, 10) || 0;
                    var basicFee = parseInt(parking.ì£¼ì°¨ê¸°ë³¸ìš”ê¸ˆ, 10) || 0;
                    var unitTime = parseInt(parking.ì¶”ê°€ë‹¨ìœ„ì‹œê°„, 10) || 1;
                    var unitFee = parseInt(parking.ì¶”ê°€ë‹¨ìœ„ìš”ê¸ˆ, 10) || 0;
                    var dailyFee = parseInt(parking["1ì¼ì£¼ì°¨ê¶Œìš”ê¸ˆ"], 10) || 0;
                    var feeInfo = parking.ìš”ê¸ˆì •ë³´;
                    if (feeInfo === "ë¬´ë£Œ") {
                        return feeInfo;
                    }

                    if (time >= 1440 && dailyFee !== 0) return dailyFee + "ì›"; // 24ì‹œê°„ ì´ìƒì´ë©´ 1ì¼ ì£¼ì°¨ê¶Œ ìš”ê¸ˆ ì ìš©
                    if (time <= basicTime) return basicFee + "ì›"; // ê¸°ë³¸ ì‹œê°„ ë‚´ì´ë©´ ê¸°ë³¸ ìš”ê¸ˆ ì ìš©

                    var extraTime = time - basicTime;
                    var extraUnits = Math.ceil(extraTime / unitTime); // ì˜¬ë¦¼ ì²˜ë¦¬
                    return (basicFee + (extraUnits * unitFee)) + "ì›";
                }
                
            function calculateAndSortParkingFees() {
                var hours = parseInt(document.getElementById('hours').value, 10) || 0;
                var minutes = parseInt(document.getElementById('minutes').value, 10) || 0;
                parkingTime = (hours * 60) + minutes; 

                if (parkingTime <= 0) {
                    alert("ì˜¬ë°”ë¥¸ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.");
                    parkingTime = null;
                    return;
                }

                var parkingListEl = document.getElementById('parkingList');
                parkingListEl.innerHTML = ""; 

                if (visibleparkinglot.length === 0) {
                    parkingListEl.innerHTML = "<li>í˜„ì¬ ì§€ë„ì— í‘œì‹œëœ ì£¼ì°¨ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
                    return;
                }
                
                    var sortedParking = visibleparkinglot.map(parking => {
                    var totalFee = calculateFee(parking, parkingTime);
                    var numericFee = (totalFee === "ë¬´ë£Œ" || totalFee === "0ì›") ? 0 : parseInt(totalFee.replace("ì›", ""), 10) || Infinity;

                    return {
                        ...parking,
                        totalFee,
                        numericFee
                    };
                }).sort((a, b) => a.numericFee - b.numericFee);

                sortedParking.forEach((parking, index) => {
                    var li = document.createElement('li');
                    li.innerHTML = `<b>${index + 1}. ${parking.ì£¼ì°¨ì¥ëª…}</b> (${parking.distance.toFixed(2)} km) - ìš”ê¸ˆ: ${parking.totalFee} (<i class="ri-star-fill"></i> ${parking.ë³„ì í‰ê·  || "í‰ì  ì—†ìŒ"})`;
                    li.onclick = function () {
                        showParkingDetail(parking);
                    };
                    parkingListEl.appendChild(li);
                });

                document.getElementById('parkingListWrap').style.display = "block";
            }

            function showRatingParkingLots() {
                var parkingListEl = document.getElementById('parkingList');
                var parkingListDelete = document.getElementById("delete-btn");
                var parkingList = document.getElementById("list-btn"); 

                var hours = parseInt(document.getElementById('hours').value, 10) || 0;
                var minutes = parseInt(document.getElementById('minutes').value, 10) || 0;
                parkingTime = (hours * 60) + minutes; 
                parkingListEl.innerHTML = "";

                if (parkingTime <= 0) {
                    parkingTime = null;
                }

                visibleparkinglot = parkingData.map(parking => {
                    var parkingLatLng = new kakao.maps.LatLng(parking.ìœ„ë„, parking.ê²½ë„);
                    var distance = getDistance(selectedPlace, parkingLatLng);
                    return { ...parking, distance };
                }).filter((parking, index, self) =>
                    parking.distance <= 2 &&
                    index === self.findIndex(p => p.id === parking.id)  
                );

                if (visibleparkinglot.length === 0) {
                    parkingListEl.innerHTML = "<li>í˜„ì¬ ì§€ë„ì— í‘œì‹œëœ ì£¼ì°¨ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
                    return;
                }
                // ë³„ì ìˆœ ì •ë ¬ (ê°™ì€ ë³„ì ì´ë©´ ê±°ë¦¬ìˆœ ì •ë ¬)
                visibleparkinglot.sort((a, b) => {
                    let ratingDiff = (b.ë³„ì í‰ê·  || 0) - (a.ë³„ì í‰ê·  || 0); 
                    if (ratingDiff !== 0) return ratingDiff; 
                    return a.distance - b.distance; 
                });

                visibleparkinglot.forEach((parking, index) => {
                    var feeText = ""; 

                    if (parkingTime !== null) {
                        var totalFee = calculateFee(parking, parkingTime);
                        feeText = ` - ìš”ê¸ˆ: ${totalFee}`;
                    }

                    var li = document.createElement('li');
                    li.innerHTML = `<b>${index + 1}. ${parking.ì£¼ì°¨ì¥ëª…}</b> (${parking.distance.toFixed(2)} km)${feeText} (<i class="ri-star-fill"></i> ${parking.ë³„ì í‰ê·  || "í‰ì  ì—†ìŒ"})`;
                    li.onclick = function () {
                        showParkingDetail(parking);
                    };
                    parkingListEl.appendChild(li);
                });

                parkingListDelete.addEventListener("click", function () {
                    parkingListWrap.style.display = "none";
                    parkingList.style.display = "block"; 
                });

                document.getElementById('parkingListWrap').style.display = "block"; 
                document.getElementById('parkingDetailWrap').style.display = "none"; 
                }

            function showParkingDetail(parking) { 
                var titleElement = document.getElementById('parkingTitle');
                var infoElement1 = document.getElementById('parkingInfo1'); 
                var infoElement2 = document.getElementById('parkingInfo2');
                var deleteBtn = document.getElementById('delete-btn2');

                if (titleElement && infoElement1 && infoElement2) {
                    titleElement.innerText = parking.ì£¼ì°¨ì¥ëª… || "ì£¼ì°¨ì¥ ì •ë³´ ì—†ìŒ";
                    infoElement1.innerText = `${parking.ìš”ê¸ˆì •ë³´ || "ìš”ê¸ˆ ì •ë³´ ì—†ìŒ"}ì£¼ì°¨ì¥`;
                    infoElement2.innerHTML = `ì£¼ì°¨ì¥ ìœ í˜•: ${parking.ì£¼ì°¨ì¥ìœ í˜• || "ìœ í˜• ì •ë³´ ì—†ìŒ"} | 
                    ì¥ì• ì¸ì „ìš©ì£¼ì°¨êµ¬ì—­: ${parking.ì¥ì• ì¸ì „ìš©ì£¼ì°¨êµ¬ì—­ë³´ìœ ì—¬ë¶€ ? "ë³´ìœ " : "ë¯¸ë³´ìœ "}<br>
                    ë‚¨ì€ìë¦¬: ${parking.ë‚¨ì€ìë¦¬}`;
                }

                selectedParkingLotId = parking.id;  
                
                document.getElementById('parkingListWrap').style.display = "none"; 
                document.getElementById('parkingDetailWrap').style.display = "block";
                deleteBtn.addEventListener("click", function () {
                    showClosestParkingLots();
                    document.getElementById('parkingListWrap').style.display = "block"; 
                    document.getElementById('parkingDetailWrap').style.display = "none";
                    }); 
                loadReviews(); 
            }

            const DEG_TO_RAD = Math.PI / 180;

            function getDistance(latlng1, latlng2) {
                var earthRadius = 6371;
                var dLat = (latlng2.getLat() - latlng1.getLat()) * DEG_TO_RAD;
                var dLng = (latlng2.getLng() - latlng1.getLng()) * DEG_TO_RAD;

                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(latlng1.getLat() * DEG_TO_RAD) *
                    Math.cos(latlng2.getLat() * DEG_TO_RAD) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);

                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return earthRadius * c;
            }

            function toggleParkingList() {
                var parkingListWrap = document.getElementById("parkingListWrap");
                var parkingList = document.getElementById("list-btn");

                if (!selectedPlace) {
                    alert("ì¥ì†Œ ì„ ì •ì„ ë¨¼ì € í•˜ì„¸ìš”!");
                    parkingListWrap.style.display = "none"; 
                    return;
                }

                if (parkingListWrap.style.display === "none" || parkingListWrap.style.display === "") {
                    showClosestParkingLots();
                    parkingList.style.display = "none"; 
                } else {
                    parkingListWrap.style.display = "none"; 
                }
            }
            {% comment %} document.addEventListener('DOMContentLoaded', () => {
                loadReviews(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ë¦¬ë·° ë¡œë“œ
            });  {% endcomment %}

            const reviewContainer = document.querySelector('.review-list');

            function toggleReview() {
                const review = document.getElementById('review');
                const toggleBtn=document.getElementById('toggle-btn');
                review.classList.toggle('active');

                if (review.classList.contains('active')) {
                    toggleBtn.classList.remove('ri-arrow-down-s-fill');
                    toggleBtn.classList.add('ri-arrow-up-s-fill');
                } else {
                    toggleBtn.classList.remove('ri-arrow-up-s-fill');
                    toggleBtn.classList.add('ri-arrow-down-s-fill');
                }
            }

            function toggleLike() {
                const heartIcon = document.getElementById("toggle-btn");
            
                if (!heartIcon) {
                    console.error("ğŸš¨ ì˜¤ë¥˜: í•˜íŠ¸ ì•„ì´ì½˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                const isLiked = heartIcon.classList.contains("ri-heart-3-fill");

                heartIcon.classList.toggle("ri-heart-3-line", isLiked);
                heartIcon.classList.toggle("ri-heart-3-fill", !isLiked);

                heartIcon.style.color = isLiked ? "black" : "red";
            }


            
            function loadReviews() {
                console.log( "selectedParkingLotId ê°’ í™•ì¸:", selectedParkingLotId);

                const url = `/api/reviews/${selectedParkingLotId}/`;
                console.log('Fetching URL:', url);
            
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        reviewContainer.innerHTML = ''; 
                        data.reviews.forEach(review => {
                            console.log("ë¦¬ë·° ê°ì²´ í™•ì¸:", review);
                            const reviewElement = `
                                <div class="review-item" id="review-${review.id}">
                                    <strong>${review.user__username}</strong>
                                    <span><i class="ri-star-fill"></i> ${review.rating}</span>
                                    <p id="content-${review.id}">${review.content || ''}</p>

                                    ${review.user__username === currentUser ? `
                                        <a href="javascript:void(0);" onclick="deleteReview(${review.id})">
                                            <i class="ri-delete-bin-6-line"></i> [ì‚­ì œ]
                                        </a>
                                        <a href="javascript:void(0);" onclick="editReview(${review.id}, ${review.rating}, '${review.content}')">
                                            <i class="ri-edit-line"></i> [ìˆ˜ì •]
                                        </a>
                                    ` : ''}
                                </div>
                            `;
                            reviewContainer.innerHTML += reviewElement;
                        });
                        initializeStarRating();
                    })
                    .catch(error => console.error('ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:', error));
            }
            
            function initializeStarRating() {
                document.querySelectorAll(".star-rating i").forEach(star => {
                    star.addEventListener("click", () => {
                        const rating = parseInt(star.getAttribute("data-value"), 10);
                        selectedRating = rating; //  ë³„ì  ê°’ ì €ì¥
                        updateStars(selectedRating);
                        document.getElementById("rating-display").textContent = `${rating}ì `;
                    });
                });
            }
            function updateStars(rating) {
                document.querySelectorAll(".star-rating i").forEach(star => {
                    const value = parseInt(star.getAttribute("data-value"), 10);
                    star.classList.toggle("ri-star-fill", value <= rating);
                    star.classList.toggle("ri-star-line", value > rating);
                });
            }
            
            function editReview(reviewId, currentRating, currentContent) {
                console.log("ìˆ˜ì •í•  ë¦¬ë·° ID:", reviewId); // âœ… ë¦¬ë·° ID ê°’ í™•ì¸
                const reviewElement = document.getElementById(`review-${reviewId}`);
                if (!reviewElement) return;
            
                reviewElement.innerHTML = `
                    <div class="star-rating">
                        ${[1, 2, 3, 4, 5].map(star => `
                            <i class="ri-star-line" data-value="${star}" onclick="selectRating(${star}, ${reviewId})"></i>
                        `).join('')}
                    </div>
                    <p id="rating-display-${reviewId}">${currentRating}ì </p>
                    <textarea id="edit-content-${reviewId}">${currentContent}</textarea>
                    <button class="review-btn" onclick="updateReview(${reviewId})">ìˆ˜ì • ì™„ë£Œ</button>
                `;
                selectRating(currentRating, reviewId);
            }
            
            function selectRating(rating, reviewId) {
                const stars = document.querySelectorAll(`#review-${reviewId} .star-rating i`);
                stars.forEach(star => {
                    const value = parseInt(star.getAttribute("data-value"), 10);
                    star.classList.toggle("ri-star-fill", value <= rating);
                    star.classList.toggle("ri-star-line", value > rating);
                });
                document.getElementById(`rating-display-${reviewId}`).textContent = `${rating}ì `;
                selectedRating = rating;
            }
            
            async function updateReview(reviewId) {
                const content = document.getElementById(`edit-content-${reviewId}`).value.trim();
                console.log("ë¦¬ë·° ë³„ì  í™•ì¸:", document.getElementById(`edit-content-${reviewId}`).value);
                if (!selectedRating) {
                    alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (!content) {
                    alert("ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                    return;
                }
                try {
                    const response = await fetch(`/api/update_review/${reviewId}/`, {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: JSON.stringify({
                            rating: selectedRating,
                            content: content,
                        }),
                    });
                    if (!response.ok) {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    }
                    alert("âœ… ë¦¬ë·°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    loadReviews();
                } catch (error) {
                    console.error("âŒ ë¦¬ë·° ìˆ˜ì • ì‹¤íŒ¨:", error);
                    alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
                }
            }
            
            async function deleteReview(reviewId) {
                if (!confirm("ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    return;
                }
            
                try {
                    const response = await fetch(`/api/delete_review/${reviewId}/`, {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                    });
            
                    if (!response.ok) {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    }
            
                    alert("âœ… ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    loadReviews();
                } catch (error) {
                    console.error("âŒ ë¦¬ë·° ì‚­ì œ ì‹¤íŒ¨:", error);
                    alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
                }
            }
            

            // â­ ë¦¬ë·° ë“±ë¡ í•¨ìˆ˜ ìˆ˜ì • (selectedRating ì‚¬ìš©)
            async function addReview() {
                const content = document.getElementById("contentInput").value.trim();
                const parkingLotId = selectedParkingLotId; // ì„ íƒëœ ì£¼ì°¨ì¥ ID ê°€ì ¸ì˜¤ê¸°

                if (!selectedRating) {
                    alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                if (!content) {
                    alert("ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                    return;
                }

                if (!parkingLotId) {
                    alert("ì£¼ì°¨ì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
                    return;
                }

                try {
                    const response = await fetch("/api/add_review/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: JSON.stringify({
                            rating: selectedRating, // â­ ì„ íƒëœ ë³„ì  ê°’ ì‚¬ìš©
                            content: content,
                            parking_lot_id: parkingLotId,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.error) {
                        alert(`ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨: ${data.error}`);
                    } else {
                        alert("âœ… ë¦¬ë·°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        console.log("âœ… ë¦¬ë·° ì¶”ê°€ë¨:", data);
                        loadReviews(); // ë¦¬ë·° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        resetStars(); // ë³„ì  ì´ˆê¸°í™”
                        document.getElementById("contentInput").value = ""; // ì…ë ¥ë‚´ìš© ì´ˆê¸°í™”
                    }
                } catch (error) {
                    console.error("âŒ ë¦¬ë·° ì¶”ê°€ ì‹¤íŒ¨:", error);
                    alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
                }
            }
            function resetStars() {
                const stars = document.querySelectorAll(".star-rating i");
                stars.forEach(star => {
                    star.classList.remove("ri-star-fill");
                    star.classList.add("ri-star-line");
                });
            
                selectedRating = 0; // ë³„ì  ê°’ ì´ˆê¸°í™”
                const ratingDisplay = document.getElementById("rating-display");
                if (ratingDisplay) {
                    ratingDisplay.textContent = "0ì "; // ë³„ì  í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                }
            }
            function toggleLike() {
                const heartIcon = document.getElementById("toggle-btn");
            
                if (!heartIcon) {
                    console.error("ğŸš¨ ì˜¤ë¥˜: í•˜íŠ¸ ì•„ì´ì½˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                const isLiked = heartIcon.classList.contains("ri-heart-3-fill");

                heartIcon.classList.toggle("ri-heart-3-line", isLiked);
                heartIcon.classList.toggle("ri-heart-3-fill", !isLiked);

                heartIcon.style.color = isLiked ? "black" : "red";
            }
            /* function toggleCommunity() {
                const community = document.getElementById('community');
                community.classList.toggle('active');
                const toggleBtn=document.getElementById('toggle-btn2');

                if (community.classList.contains('active')) {
                    toggleBtn.classList.remove('ri-arrow-down-s-fill');
                    toggleBtn.classList.add('ri-arrow-up-s-fill');
                } else {
                    toggleBtn.classList.remove('ri-arrow-up-s-fill');
                    toggleBtn.classList.add('ri-arrow-down-s-fill');
                }
            }
            const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                const messagesDiv = document.getElementById('messages');
                const newMessage = document.createElement('div');
                newMessage.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
                messagesDiv.appendChild(newMessage);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;  // ìŠ¤í¬ë¡¤ ìë™ ì´ë™
            };

            function sendMessage() {
                const inputBox = document.getElementById('message-input');
                const message = inputBox.value;
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'username': 'ìµëª…'  // ì‚¬ìš©ì ì´ë¦„ ì¶”ê°€ ê°€ëŠ¥
                }));
                inputBox.value = '';
            }*/
        </script>
        {% endblock %}