{% load static %}
{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/style-pth.css' %}">
{% endblock %}
{% block content %}
        <div class="option">
            <form onsubmit="searchPlaces(); return false;">
                    <input type="text" value=" " id="keyword" size="15"> 
                    <button type="submit" class="search-button">ê²€ìƒ‰</button> 
            </form>
        </div>
        <div class="map_wrap">
            <div id="map"></div>

            <div id="menu_wrap" class="bg_white">
                <hr>
                <ul id="placesList"></ul>
                <div id="pagination"></div>
            </div>
            <div class="bottom-btn"> 
                <button class="list-button" onclick="toggleParkingList()">ì£¼ì°¨ì¥ ë¦¬ìŠ¤íŠ¸</button>
            </div>
            <div id="parkingListWrap" style="display: none;">
                <ul id="parkingList"></ul>
            </div>
        </div>
        <div id="parkingDetailWrap" style="display: none;">
            <h3 id="parkingTitle">ì£¼ì°¨ì¥ ì´ë¦„</h3>
            <p id="parkingReview">ë¦¬ë·°
                <i onclick="toggleReview()" class="ri-arrow-down-s-fill"></i>
            </p>
            <div id="review" class="review">
                {% for review in reviews %}
                <div class="review-item">
                    <p><strong>{{ review.user.username }}</strong> â­ {{ review.rating }}</p>
                    <p>{{ review.content }}</p>
                </div>
                {% empty %}
                <p>ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endfor %}
                <input type="number" id="ratingInput" min="1" max="5" placeholder="í‰ì (1~5)" />
                <textarea id="contentInput" placeholder="ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <button class="review-btn" onclick="addReview()">ë¦¬ë·° ë“±ë¡</button>
                <div class="review-list">
                </div>
            </div>
            <p id="parkingCommunity">ì»¤ë®¤ë‹ˆí‹°
                <i onclick="toggleCommunity()" class="ri-arrow-down-s-fill"></i>
            </p>
            <div id="community" class="community">
                <div class="messages">
                </div>
                <div class="input-msg">
                    <input id="messageInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                    <button class="community-btn" onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
            <button class="off-button" onclick="closeParkingDetail()">ë‹«ê¸°</button>
        </div>
        {% endblock %}
        {% block scripts %}

        {% if parking_data %}
        {{ parking_data | json_script:'jsonData' }}
        {% endif %}
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=&libraries=services"></script>
        <script>
            var markers = [];
            var parkingData = [];
            var selectedPlace = null;

            var mapContainer = document.getElementById('map'), 
                mapOption = {
                    center: new kakao.maps.LatLng(37.566826, 126.9786567), 
                    level: 3 
                };

            var map = new kakao.maps.Map(mapContainer, mapOption); 

            var ps = new kakao.maps.services.Places(); 

            var infowindow = new kakao.maps.InfoWindow({ zIndex: 1 }); 
            
            searchPlaces(); 
            loadParkingData();

            function searchPlaces() {
                var keyword = document.getElementById('keyword').value;

                if (!keyword.replace(/^\s+|\s+$/g, '')) {
                    alert('ì£¼ì†Œë‚˜ ì¥ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return false;
                }

                ps.keywordSearch(keyword, placesSearchCB); // ì¥ì†Œ ê²€ìƒ‰ ìš”ì²­
            }

            function placesSearchCB(data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
                    var menuEl = document.getElementById('menu_wrap');
                    menuEl.style.display = 'block';
                    displayPlaces(data); 
                    displayPagination(pagination); 
                } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                } else if (status === kakao.maps.services.Status.ERROR) {
                    alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            function displayPlaces(places) {
                var listEl = document.getElementById('placesList');
                var menuEl = document.getElementById('menu_wrap');
                var fragment = document.createDocumentFragment();
                var bounds = new kakao.maps.LatLngBounds();

                removeAllChildNods(listEl); 
                removeMarker(); 

                for (var i = 0; i < places.length; i++) {
                    var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x);
                    var marker = addMarker(placePosition, i);
                    var itemEl = getListItem(i, places[i]);

                    bounds.extend(placePosition); 

                    (function (marker, title) {
                        kakao.maps.event.addListener(marker, 'mouseover', function () {
                            displayInfowindow(marker, title);
                        });

                        kakao.maps.event.addListener(marker, 'mouseout', function () {
                            infowindow.close();
                        });

                        itemEl.onmouseover = function () {
                            displayInfowindow(marker, title);
                        };

                        itemEl.onmouseout = function () {
                            infowindow.close();
                        };

                        itemEl.onclick = function () {
                            focusOnPlace(marker);
                        };

                        kakao.maps.event.addListener(marker, 'click', function () {
                            focusOnPlace(marker);
                        });
                    })(marker, places[i].place_name);

                    fragment.appendChild(itemEl);
                }

                listEl.appendChild(fragment);
                menuEl.scrollTop = 0;

                map.setBounds(bounds); 
            }

            function getListItem(index, places) {
                var el = document.createElement('li');
                var itemStr =
                    '<span class="markerbg marker_' +
                    (index + 1) +
                    '"></span>' +
                    '<div class="info">' +
                    '<h5>' +
                    places.place_name +
                    '</h5>';

                if (places.road_address_name) {
                    itemStr +=
                        '<span>' +
                        places.road_address_name +
                        '</span>' +
                        '<span class="jibun gray">' +
                        places.address_name +
                        '</span>';
                } else {
                    itemStr += '<span>' + places.address_name + '</span>';
                }

                itemStr += '<span class="tel">' + places.phone + '</span></div>';

                el.innerHTML = itemStr;
                el.className = 'item';

                return el;
            }

            function addMarker(position, idx, title) {
                var imageSrc =
                    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png';
                var imageSize = new kakao.maps.Size(36, 37);
                var imgOptions = {
                    spriteSize: new kakao.maps.Size(36, 691),
                    spriteOrigin: new kakao.maps.Point(0, idx * 46 + 10),
                    offset: new kakao.maps.Point(13, 37),
                };

                var markerImage = new kakao.maps.MarkerImage(
                    imageSrc,
                    imageSize,
                    imgOptions
                );
                var marker = new kakao.maps.Marker({
                    position: position,
                    image: markerImage,
                });

                marker.setMap(map);
                markers.push(marker);

                return marker;
            }
            function addparkMarker(position, idx, title) {
                var marker = new kakao.maps.Marker({
                    position: position, 
                });

                marker.setMap(map);
                markers.push(marker);

                var infowindow = new kakao.maps.InfoWindow({
                    content: `<div style="padding:5px; font-size:12px;">${title}</div>` // 
                });

                kakao.maps.event.addListener(marker, 'mouseover', function() {
                    infowindow.open(map, marker);
                });

                kakao.maps.event.addListener(marker, 'mouseout', function() {
                    infowindow.close();
                });

                return marker;
            }
            function removeMarker(exceptMarker = null) {
                for (var i = 0; i < markers.length; i++) {
                    if (markers[i] !== exceptMarker) {
                        markers[i].setMap(null);
                    }
                }
                markers = exceptMarker ? [exceptMarker] : [];
            }

            function displayPagination(pagination) {
                var paginationEl = document.getElementById('pagination');
                var fragment = document.createDocumentFragment();
                var i;

                while (paginationEl.hasChildNodes()) {
                    paginationEl.removeChild(paginationEl.lastChild);
                }

                for (i = 1; i <= pagination.last; i++) {
                    var el = document.createElement('a');
                    el.href = '#';
                    el.innerHTML = i;

                    if (i === pagination.current) {
                        el.className = 'on';
                    } else {
                        el.onclick = (function (i) {
                            return function () {
                                pagination.gotoPage(i);
                            };
                        })(i);
                    }

                    fragment.appendChild(el);
                }
                paginationEl.appendChild(fragment);
            }

            function displayInfowindow(marker, title) {
                var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';
                infowindow.setContent(content);
                infowindow.open(map, marker);
            }

            function focusOnPlace(marker) {
                var menuEl = document.getElementById('menu_wrap');
                menuEl.style.display = 'none';
                removeMarker(marker); 
                map.setLevel(4);
                
                map.setCenter(marker.getPosition());
                infowindow.close();

                selectedPlace = marker.getPosition();

                var lat = marker.getPosition().getLat();
                var lng = marker.getPosition().getLng();
                showParkingMarkers(parkingData);
            }

            // JSON íŒŒì¼ì—ì„œ ì£¼ì°¨ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            function loadParkingData() {
                var placeData = JSON.parse(document.getElementById('jsonData').textContent);
                placeData.forEach(function(place) {
                    parkingData.push({
                        'ì£¼ì°¨ì¥ëª…': place['ì£¼ì°¨ì¥ëª…'], 
                        'ìœ„ë„': place['ìœ„ë„'], 
                        'ê²½ë„': place['ê²½ë„']
                    });
                });
            }
            // ğŸ…¿ï¸ ì£¼ì°¨ì¥ ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
            function showParkingMarkers(parkingList) {
                for (var i = 0; i < parkingList.length; i++) {
                    var parkingLatLng = new kakao.maps.LatLng(parkingList[i].ìœ„ë„, parkingList[i].ê²½ë„);
                    var marker = addparkMarker(parkingLatLng, i,parkingList[i].ì£¼ì°¨ì¥ëª…);
                }
            }

            function removeAllChildNods(el) {
                while (el.hasChildNodes()) {
                    el.removeChild(el.lastChild);
                }
            }
            function showClosestParkingLots() {
                if (!selectedPlace) {
                    alert("ë¨¼ì € ê²€ìƒ‰ í›„ ì¥ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”!");
                    return;
                }

                var parkingListEl = document.getElementById('parkingList');
                parkingListEl.innerHTML = ""; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”

                var distances = parkingData.map(parking => {
                    var parkingLatLng = new kakao.maps.LatLng(parking.ìœ„ë„, parking.ê²½ë„);
                    var distance = getDistance(selectedPlace, parkingLatLng);
                    return { ...parking, distance };
                });

                // ê±°ë¦¬ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ í›„ ìƒìœ„ 8ê°œ ì„ íƒ
                distances.sort((a, b) => a.distance - b.distance);
                var closestParking = distances.slice(0, 8);

                if (closestParking.length === 0) {
                    alert("ê·¼ì²˜ì— ì£¼ì°¨ì¥ì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                closestParking.forEach((parking, index) => {
                    var li = document.createElement('li');
                    li.innerHTML = `<b>${index + 1}. ${parking.ì£¼ì°¨ì¥ëª…}</b> (${parking.distance.toFixed(2)}km)`;
                    li.onclick = function() {
                        showParkingDetail(parking);
                    };
                    parkingListEl.appendChild(li);
                });

                document.getElementById('parkingListWrap').style.display = "block"; // ë¦¬ìŠ¤íŠ¸ ë³´ì´ê¸°
                document.getElementById('parkingDetailWrap').style.display = "none"; // ìƒì„¸ ì •ë³´ ìˆ¨ê¸°ê¸°
            }

            function showParkingDetail(parking) { 
                var titleElement = document.getElementById('parkingTitle');

                if (titleElement) {
                    titleElement.innerText = parking.ì£¼ì°¨ì¥ëª… || "ì£¼ì°¨ì¥ ì •ë³´ ì—†ìŒ"; // âœ… ì£¼ì°¨ì¥ëª…ì´ ì—†ì„ ê²½ìš° ëŒ€ë¹„
                } else {
                }

                document.getElementById('parkingListWrap').style.display = "none"; // âœ… ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¹€
                document.getElementById('parkingDetailWrap').style.display = "block"; // âœ… ìƒì„¸ ì •ë³´ ë³´ì´ê¸°
            }

            function closeParkingDetail() {
                document.getElementById('parkingDetailWrap').style.display = "none"; // âœ… ìƒì„¸ ì •ë³´ ìˆ¨ê¸°ê¸°
                document.getElementById('parkingListWrap').style.display = "block"; // âœ… ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë³´ì´ê¸°
            }

            function getDistance(latlng1, latlng2) {
                var earthRadius = 6371; 
                var dLat = (latlng2.getLat() - latlng1.getLat()) * (Math.PI / 180);
                var dLng = (latlng2.getLng() - latlng1.getLng()) * (Math.PI / 180);

                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(latlng1.getLat() * (Math.PI / 180)) *
                    Math.cos(latlng2.getLat() * (Math.PI / 180)) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);

                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return earthRadius * c; // ê±°ë¦¬ ë°˜í™˜ (km)
            }
            function toggleParkingList() {
                var parkingListWrap = document.getElementById("parkingListWrap");

                if (parkingListWrap.style.display === "none" || parkingListWrap.style.display === "") {
                    showClosestParkingLots(); // ê°€ì¥ ê°€ê¹Œìš´ ì£¼ì°¨ì¥ 8ê°œ ê°€ì ¸ì˜¤ê¸°
                    parkingListWrap.style.display = "flex"; 
                    parkingListWrap.style.alignItems = "center"; 
                    parkingListWrap.style.justifyContent = "center";
                } else {
                    parkingListWrap.style.display = "none"; 
                }
            }
            const reviewContainer = document.getElementById('review');
            function toggleReview() {
                const review = document.getElementById('review');
                review.classList.toggle('active');
              }
            function loadReviews() {
            fetch('/api/reviews/')
                .then(response => response.json())
                .then(data => {
                    reviewContainer.innerHTML = ''; // ê¸°ì¡´ ë¦¬ë·° ì´ˆê¸°í™”
                    data.reviews.forEach(review => {
                        const reviewElement = `
                            <div class="review-item">
                                <strong>${review.user__username}</strong>
                                <span>â­ ${review.rating}</span>
                                <p>${review.content || ''}</p>
                            </div>
                            <hr>
                        `;
                        reviewContainer.innerHTML += reviewElement;
                    });
                })
                .catch(error => console.error('ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:', error));
            }
            function addReview() {
                const rating = document.getElementById('ratingInput').value;
                const content = document.getElementById('contentInput').value;
        
                fetch('/api/add_review/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({ rating, content }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            alert('ë¦¬ë·°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                            loadReviews(); // ë¦¬ë·° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        }
                    })
                    .catch(error => console.error('ë¦¬ë·° ì¶”ê°€ ì‹¤íŒ¨:', error));
            }
            function toggleCommunity() {
            const community = document.getElementById('community');
            community.classList.toggle('active');
            }
            const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                const messagesDiv = document.getElementById('messages');
                const newMessage = document.createElement('div');
                newMessage.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
                messagesDiv.appendChild(newMessage);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;  // ìŠ¤í¬ë¡¤ ìë™ ì´ë™
            };

            function sendMessage() {
                const inputBox = document.getElementById('message-input');
                const message = inputBox.value;
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'username': 'ìµëª…'  // ì‚¬ìš©ì ì´ë¦„ ì¶”ê°€ ê°€ëŠ¥
                }));
                inputBox.value = '';
            }
        </script>
        {% endblock %}